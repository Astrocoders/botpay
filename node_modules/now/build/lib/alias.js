"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function resolve4(e){return new _promise2["default"](function(r,t){return _dns2["default"].resolve4(e,function(e,n){return e?t(e):void r(n)})})}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_asyncRetry=require("async-retry"),_asyncRetry2=_interopRequireDefault(_asyncRetry),_dns=require("dns"),_dns2=_interopRequireDefault(_dns),_lib=require("../lib"),_lib2=_interopRequireDefault(_lib),_toHost=require("./to-host"),_toHost2=_interopRequireDefault(_toHost),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),Alias=function(e){function r(){return(0,_classCallCheck3["default"])(this,r),(0,_possibleConstructorReturn3["default"])(this,(0,_getPrototypeOf2["default"])(r).apply(this,arguments))}return(0,_inherits3["default"])(r,e),(0,_createClass3["default"])(r,[{key:"ls",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e){var r,n=this;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!e){t.next=5;break}return t.delegateYield(_regenerator2["default"].mark(function a(){var r,t;return _regenerator2["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,n.findDeployment(e);case 2:if(r=a.sent){a.next=7;break}throw t=new Error('Aliases not found by "'+e+'". Run '+_chalk2["default"].dim("`now alias ls`")+" to see your aliases."),t.userError=!0,t;case 7:return a.abrupt("return",{v:n.retry(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e,a){var u,o;return _regenerator2["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n._fetch("/now/deployments/"+r.uid+"/aliases");case 2:return u=e.sent,e.next=5,u.json();case 5:return o=e.sent,e.abrupt("return",o.aliases);case 7:case"end":return e.stop()}},t,n)}));return function(r,t){return e.apply(this,arguments)}}())});case 8:case"end":return a.stop()}},a,n)})(),"t0",2);case 2:if(r=t.t0,"object"!==("undefined"==typeof r?"undefined":(0,_typeof3["default"])(r))){t.next=5;break}return t.abrupt("return",r.v);case 5:return t.abrupt("return",this.retry(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t){var a,u;return _regenerator2["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n._fetch("/now/aliases");case 2:return a=e.sent,e.next=5,a.json();case 5:return u=e.sent,e.abrupt("return",u.aliases);case 7:case"end":return e.stop()}},r,n)}));return function(r,t){return e.apply(this,arguments)}}()));case 6:case"end":return t.stop()}},t,this)}));return e}()},{key:"rm",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e){var r=this;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.retry(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function n(t,a){var u,o;return _regenerator2["default"].wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,r._fetch("/now/aliases/"+e.uid,{method:"DELETE"});case 2:if(u=n.sent,403!==u.status){n.next=5;break}return n.abrupt("return",t(new Error("Unauthorized")));case 5:if(200===u.status){n.next=8;break}throw o=new Error("Deletion failed. Try again later.");case 8:case"end":return n.stop()}},n,r)}));return function(e,r){return t.apply(this,arguments)}}()));case 1:case"end":return t.stop()}},t,this)}));return e}()},{key:"findDeployment",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e){var r,n,a,u,o=this;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.list();case 2:return r=t.sent,n=void 0,a=void 0,/\./.test(e)?(a=(0,_toHost2["default"])(e),n="url"):(a=e,n="uid"),u=r.find(function(e){return e[n]===a?(o._debug&&console.log("> [debug] matched deployment "+e.uid+" by "+n+" "+a),!0):a+".now.sh"===e.url?(o._debug&&console.log("> [debug] matched deployment "+e.uid+" by url "+e.url),!0):!1}),t.abrupt("return",u);case 7:case"end":return t.stop()}},t,this)}));return e}()},{key:"set",value:function(){function e(e,t){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e,r){var n,a,u,o,s;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=r.toLowerCase(),t.next=3,this.findDeployment(e);case 3:if(n=t.sent){t.next=8;break}throw a=new Error('Deployment not found by "'+e+'". Run '+_chalk2["default"].dim("`now ls`")+" to see your deployments."),a.userError=!0,a;case 8:if(/\./.test(r)?r=(0,_toHost2["default"])(r):(this._debug&&console.log("> [debug] suffixing `.now.sh` to alias "+r),r+=".now.sh"),/\.now\.sh$/.test(r)){t.next=15;break}return console.log("> "+_chalk2["default"].bold(_chalk2["default"].underline(r))+" is a custom domain."),console.log("> Verifying that "+_chalk2["default"].bold(_chalk2["default"].underline(r))+" has a "+_chalk2["default"].cyan("`CNAME`")+" or "+_chalk2["default"].cyan("`ALIAS`")+" record pointing to "+_chalk2["default"].bold(_chalk2["default"].underline("alias.zeit.co"))+"."),t.next=14,this.verifyOwnership(r);case 14:console.log("> Verification "+_chalk2["default"].bold("OK")+"!");case 15:return t.next=17,this.createAlias(n,r);case 17:u=t.sent,o=u.created,s=u.uid,o?console.log(_chalk2["default"].cyan("> Success!")+" Alias created "+_chalk2["default"].dim("("+s+")")+": "+_chalk2["default"].bold("https://"+n.url)+" "+_chalk2["default"].dim("("+n.uid+")")+" now points to "+_chalk2["default"].bold(_chalk2["default"].underline("https://"+r))):console.log(_chalk2["default"].cyan("> Success!")+" Alias already exists "+_chalk2["default"].dim("("+s+")")+".");case 21:case"end":return t.stop()}},t,this)}));return e}()},{key:"createAlias",value:function(e,r){var t=this;return this.retry(function(){var n=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function a(n,u){var o,s,i,l,c,f;return _regenerator2["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return t._debug&&console.time("> [debug] /now/deployments/"+e.uid+"/aliases #"+u),a.next=3,t._fetch("/now/deployments/"+e.uid+"/aliases",{method:"POST",body:{alias:r}});case 3:return o=a.sent,a.next=6,o.json();case 6:if(s=a.sent,t._debug&&console.timeEnd("> [debug] /now/deployments/"+e.uid+"/aliases #"+u),409!==o.status){a.next=10;break}return a.abrupt("return",{uid:s.error.uid});case 10:if(403!==o.status){a.next=21;break}if(i=s.error.code,"custom_domain_needs_upgrade"!==i){a.next=16;break}return l=new Error("Custom domains are only enabled for premium accounts. Please upgrade at "+_chalk2["default"].underline("https://zeit.co/account")+"."),l.userError=!0,a.abrupt("return",n(l));case 16:if("alias_in_use"!==i){a.next=20;break}return c=new Error("The alias you are trying to configure ("+_chalk2["default"].underline(_chalk2["default"].bold(r))+") is already in use by a different account."),c.userError=!0,a.abrupt("return",n(c));case 20:return a.abrupt("return",n(new Error("Authorization error")));case 21:if(!s.error){a.next=31;break}if(f=s.error.code,"deployment_not_found"!==f){a.next=25;break}return a.abrupt("return",n(new Error("Deployment not found")));case 25:if("cert_missing"!==f){a.next=30;break}return console.log("> Provisioning certificate for "+_chalk2["default"].underline(_chalk2["default"].bold(r))),a.next=29,t.createCert(r);case 29:return a.abrupt("return",t.createAlias(e,r));case 30:return a.abrupt("return",n(new Error(s.error.message)));case 31:if(200===o.status||304===o.status){a.next=33;break}throw new Error("Unhandled error");case 33:return a.abrupt("return",s);case 34:case"end":return a.stop()}},a,t)}));return function(e,r){return n.apply(this,arguments)}}())}},{key:"verifyOwnership",value:function(e){var r=this;return this.retry(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function n(t,a){var u,o,s,i,l,c,f,d,_,p;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,resolve4("alias.zeit.co");case 2:if(u=r.sent,u.length){r.next=5;break}return r.abrupt("return",t(new Error("Unable to resolve alias.zeit.co")));case 5:return r.next=7,resolve4(e);case 7:if(o=r.sent,o.length){r.next=12;break}return s=new Error("The domain ${domain} A record in the DNS configuration is not returning any IPs."),s.userError=!0,r.abrupt("return",t(s));case 12:i=!0,l=!1,c=void 0,r.prev=15,f=(0,_getIterator3["default"])(o);case 17:if(i=(d=f.next()).done){r.next=26;break}if(_=d.value,~u.indexOf(_)){r.next=23;break}return p=new Error("The domain "+e+" has an A record "+_chalk2["default"].bold(_)+" that doesn't resolve to "+_chalk2["default"].bold(_chalk2["default"].underline("alias.zeit.co"))+". Please check your DNS settings."),p.userError=!0,r.abrupt("return",t(p));case 23:i=!0,r.next=17;break;case 26:r.next=32;break;case 28:r.prev=28,r.t0=r["catch"](15),l=!0,c=r.t0;case 32:r.prev=32,r.prev=33,!i&&f["return"]&&f["return"]();case 35:if(r.prev=35,!l){r.next=38;break}throw c;case 38:return r.finish(35);case 39:return r.finish(32);case 40:case"end":return r.stop()}},n,r,[[15,28,32,40],[33,,35,39]])}));return function(e,r){return t.apply(this,arguments)}}())}},{key:"createCert",value:function(e){var r=this;return this.retry(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function n(t,a){var u,o,s,i;return _regenerator2["default"].wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return r._debug&&console.time("> [debug] /now/certs #"+a),n.next=3,r._fetch("/now/certs",{method:"POST",body:{domains:[e]}});case 3:if(u=n.sent,304!==u.status){n.next=7;break}return console.log("> Certificate already issued."),n.abrupt("return");case 7:return n.next=9,u.json();case 9:if(o=n.sent,r._debug&&console.timeEnd("> [debug] /now/certs #"+a),!o.error){n.next=18;break}if(s=o.error.code,"verification_failed"!==s){n.next=17;break}return i=new Error("We couldn't verify ownership of the domain "+e+". Make sure the appropriate `ALIAS` or `CNAME` records are configured and pointing to "+_chalk2["default"].bold("alias.zeit.co")+"."),i.userError=!0,n.abrupt("return",t(i));case 17:throw new Error(o.message);case 18:if(200===u.status||304===u.status){n.next=20;break}throw new Error("Unhandled error");case 20:case"end":return n.stop()}},n,r)}));return function(e,r){return t.apply(this,arguments)}}())}},{key:"retry",value:function(e){return(0,_asyncRetry2["default"])(e,{retries:5,randomize:!0,onRetry:this._onRetry})}}]),r}(_lib2["default"]);exports["default"]=Alias;