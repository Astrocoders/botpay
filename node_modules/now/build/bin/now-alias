#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(r[a]=e[a]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function indent(e,r){return e.split("\n").map(function(e){return" ".repeat(r)+e}).join("\n")}function findAlias(e,r){var a=void 0,t=void 0;/\./.test(e)?(t=(0,_toHost2["default"])(e),a="alias"):(t=e,a="uid");var n=r.find(function(e){return e[a]===t?(debug&&console.log("> [debug] matched alias "+e.uid+" by "+a+" "+t),!0):t+".now.sh"===e.alias?(debug&&console.log("> [debug] matched alias "+e.uid+" by url "+e.host),!0):!1});return n}var _slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_toConsumableArray2=require("babel-runtime/helpers/toConsumableArray"),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),run=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var a,t,n,i,l,u,o,s,c,d,f,_,p,m,h,g,b,y;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:a=new _alias3["default"](apiUrl,e,{debug:debug}),t=argv._.slice(1),r.t0=subcommand,r.next="list"===r.t0?5:"ls"===r.t0?5:"remove"===r.t0?22:"rm"===r.t0?22:"add"===r.t0?52:"set"===r.t0?52:58;break;case 5:return r.next=7,a.list();case 7:return n=r.sent,i=new _map2["default"](n.map(function(e){return[e.uid,e.url]})),l=null!=t[0]?String(t[0]):null,r.next=12,a.ls(l);case 12:return u=r.sent,o=new _map2["default"],l?o.set(l,u):u.forEach(function(e){var r=o.get(e.deploymentId)||[];o.set(e.deploymentId,r.concat(e))}),r.next=17,sort([].concat((0,_toConsumableArray3["default"])(o)));case 17:return s=r.sent,c=new Date,d=s.map(function(e){var r=(0,_slicedToArray3["default"])(e,2),a=r[0],t=r[1];return(0,_textTable2["default"])(t.map(function(e){var r=_chalk2["default"].underline("https://"+e.alias),t=_chalk2["default"].underline("https://"+i.get(a)),n=_chalk2["default"].gray((0,_ms2["default"])(c-new Date(e.created))+" ago");return[e.uid,t,r,n]}),{align:["l","r","l"],hsep:" ".repeat(3)})}).join("\n\n"),d&&console.log("\n"+d+"\n"),r.abrupt("break",64);case 22:if(f=String(t[0])){r.next=27;break}throw _=new Error("No alias id specified"),_.userError=!0,_;case 27:return r.next=29,a.ls();case 29:if(p=r.sent,m=findAlias(f,p)){r.next=35;break}throw h=new Error('Alias not found by "'+f+'". Run '+_chalk2["default"].dim("`now alias ls`")+" to see your aliases."),h.userError=!0,h;case 35:return r.prev=35,r.next=38,readConfirmation(a,m);case 38:return g=r.sent.toLowerCase(),"y"!==g&&"yes"!==g&&(console.log("\n> Aborted"),process.exit(0)),b=new Date,r.next=43,a.rm(m);case 43:y=(0,_ms2["default"])(new Date-b),console.log(_chalk2["default"].cyan("> Success!")+" Alias "+_chalk2["default"].bold(m.uid)+" removed ["+y+"]"),r.next=51;break;case 47:r.prev=47,r.t1=r["catch"](35),(0,_error.error)(r.t1),exit(1);case 51:return r.abrupt("break",64);case 52:if(2===t.length){r.next=55;break}return(0,_error.error)("Invalid number of arguments"),r.abrupt("return");case 55:return r.next=57,a.set(String(t[0]),String(t[1]));case 57:return r.abrupt("break",64);case 58:if(2!==argv._.length){r.next=63;break}return r.next=61,a.set(String(argv._[0]),String(argv._[1]));case 61:r.next=64;break;case 63:argv._.length>=3?((0,_error.error)("Invalid number of arguments"),help(),exit(1)):((0,_error.error)("Please specify a valid subcommand: ls | set | rm"),help(),exit(1));case 64:a.close();case 65:case"end":return r.stop()}},r,this,[[35,47]])}));return function(r){return e.apply(this,arguments)}}(),sort=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var a,t;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return a=void 0,r.prev=1,r.next=4,fs.readFile("package.json");case 4:t=r.sent,a=JSON.parse(t),r.next=11;break;case 8:r.prev=8,r.t0=r["catch"](1),a={};case 11:return r.abrupt("return",e.map(function(e){var r=(0,_slicedToArray3["default"])(e,2),a=r[0],t=r[1];return t=t.slice().sort(function(e,r){return r.created-e.created}),[a,t]}).sort(function(e,r){var t=(0,_slicedToArray3["default"])(e,2),n=t[0],i=t[1],l=(0,_slicedToArray3["default"])(r,2),u=l[0],o=l[1];return a.name===n?-1:a.name===u?1:o[0].created-i[0].created}));case 12:case"end":return r.stop()}},r,this,[[1,8]])}));return function(r){return e.apply(this,arguments)}}(),readConfirmation=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,a){var t,n;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.list();case 2:return t=r.sent,n=new _map2["default"](t.map(function(e){return[e.uid,e.url]})),r.abrupt("return",new _promise2["default"](function(e,r){var t=_chalk2["default"].gray((0,_ms2["default"])(new Date-new Date(a.created))+" ago"),i=_chalk2["default"].underline("https://"+n.get(a.deploymentId)),l=(0,_textTable2["default"])([[a.uid,i,_chalk2["default"].underline("https://"+a.alias),t]],{align:["l","r","l"],hsep:" ".repeat(6)});process.stdout.write("> The following deployment will be removed permanently\n"),process.stdout.write("  "+l+"\n"),process.stdout.write("  "+_chalk2["default"].bold.red("> Are you sure?")+" "+_chalk2["default"].gray("[yN] ")),process.stdin.on("data",function(r){process.stdin.pause(),e(r.toString().trim())}).resume()}));case 5:case"end":return r.stop()}},r,this)}));return function(r,a){return e.apply(this,arguments)}}(),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_textTable=require("text-table"),_textTable2=_interopRequireDefault(_textTable),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),_alias2=require("../lib/alias"),_alias3=_interopRequireDefault(_alias2),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_error=require("../lib/error"),_toHost=require("../lib/to-host"),_toHost2=_interopRequireDefault(_toHost),argv=(0,_minimist2["default"])(process.argv.slice(2),{"boolean":["help","debug"],alias:{help:"h",debug:"d"}}),subcommand=argv._[0],help=function(){console.log("\n  "+_chalk2["default"].bold("ùö´ now alias")+" <ls | set | rm> <deployment> <alias>\n\n  "+_chalk2["default"].dim("Options:")+"\n\n    -h, --help   output usage information\n    -d, --debug  debug mode [off]\n\n  "+_chalk2["default"].dim("Examples:")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Lists all your aliases:\n\n      "+_chalk2["default"].cyan("$ now alias ls")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Adds a new alias to "+_chalk2["default"].underline("my-api.now.sh")+":\n\n      "+_chalk2["default"].cyan("$ now alias set "+_chalk2["default"].underline("api-ownv3nc9f8.now.sh")+" "+_chalk2["default"].underline("my-api.now.sh"))+"\n\n      The "+_chalk2["default"].dim("`.now.sh`")+" suffix can be ommited:\n\n      "+_chalk2["default"].cyan("$ now alias set api-ownv3nc9f8 my-api")+"\n\n      The deployment id can be used as the source:\n\n      "+_chalk2["default"].cyan("$ now alias set deploymentId my-alias")+"\n\n      Custom domains work as alias targets:\n\n      "+_chalk2["default"].cyan("$ now alias set "+_chalk2["default"].underline("api-ownv3nc9f8.now.sh")+" "+_chalk2["default"].underline("my-api.com"))+"\n\n      "+_chalk2["default"].dim("‚Äì")+" The subcommand "+_chalk2["default"].dim("`set`")+" is the default and can be skipped.\n      "+_chalk2["default"].dim("‚Äì")+" "+_chalk2["default"].dim("`http(s)://`")+" in the URLs is unneeded / ignored.\n\n  "+_chalk2["default"].gray("‚Äì")+" Removing an alias:\n\n      "+_chalk2["default"].cyan("$ now alias rm aliasId")+"\n\n      To get the list of alias ids, use "+_chalk2["default"].dim("`now alias ls`")+".\n\n  "+_chalk2["default"].dim("Alias:")+" ln\n")},debug=argv.debug,apiUrl=argv.url||"https://api.zeit.co",exit=function(e){setTimeout(function(){return process.exit(e||0)},100)};if(argv.help||!subcommand)help(),exit(0);else{var config=cfg.read();_promise2["default"].resolve(config.token||(0,_login2["default"])(apiUrl)).then(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,run(e);case 3:r.next=9;break;case 5:r.prev=5,r.t0=r["catch"](0),r.t0.userError?(0,_error.error)(r.t0.message):(0,_error.error)("Unknown error: "+r.t0.stack),exit(1);case 9:case"end":return r.stop()}},r,void 0,[[0,5]])}));return function(r){return e.apply(this,arguments)}}())["catch"](function(e){(0,_error.error)("Authentication error ‚Äì "+e.message),exit(1)})}